<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” Aura Intuitive</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#7b2d3f">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Background -->
    <div class="bg-aurora">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>
    <div class="stars-canvas" id="starsCanvas"></div>

    <!-- Navigation -->
    <nav class="navbar scrolled">
        <a href="/" class="nav-brand">âœ¦ Aura Intuitive</a>
        <button class="btn btn-glass btn-sm" id="logoutBtn" style="display:none;font-size:0.8rem;padding:0.4rem 1rem;" onclick="logout()">
            DÃ©connexion
        </button>
    </nav>

    <!-- â•â•â• LOGIN â•â•â• -->
    <section class="section admin-page" id="loginSection">
        <div class="admin-login">
            <h2>ğŸ”® Espace Admin</h2>
            <p>Connectez-vous pour gÃ©rer les consultations.</p>
            <div class="login-form">
                <input type="password" id="loginPassword" placeholder="Mot de passe" autocomplete="current-password">
                <p class="login-error" id="loginError"></p>
                <button class="btn btn-gold" style="width:100%;" onclick="login()">Se connecter âœ¦</button>
            </div>
        </div>
    </section>

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <section class="section admin-page" id="dashboardSection" style="display:none;">

        <div class="admin-header">
            <h2>ğŸ“‹ Consultations</h2>
            <div style="display:flex;align-items:center;gap:0.8rem;">
                <div class="auto-refresh-indicator">
                    <span class="pulse-dot"></span> Auto-refresh
                </div>
                <button class="btn btn-glass" style="font-size:0.8rem;padding:0.5rem 1rem;" onclick="loadAll()">
                    ğŸ”„ RafraÃ®chir
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="admin-stats" id="statsBar">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">â€”</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPending">â€”</div>
                <div class="stat-label">âœ¦ En attente</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAnswered">â€”</div>
                <div class="stat-label">âœ… RÃ©pondues</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statRevenue">â€”</div>
                <div class="stat-label">ğŸ’° Revenus</div>
            </div>
        </div>

        <!-- Search -->
        <div class="admin-search">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Rechercher par nom ou email..." oninput="renderConsultations()">
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" data-filter="submitted" onclick="filterTab(this)">
                âœ¦ En attente
            </button>
            <button class="admin-tab" data-filter="answered" onclick="filterTab(this)">
                âœ… RÃ©pondues
            </button>
            <button class="admin-tab" data-filter="all" onclick="filterTab(this)">
                ğŸ“‹ Toutes
            </button>
        </div>

        <div class="consult-list" id="consultList">
            <div class="consult-empty">Chargement...</div>
        </div>
    </section>

    <!-- â•â•â• MODAL CONFIRMATION â•â•â• -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">ğŸ—‘ï¸</div>
            <h3 class="modal-title">Supprimer cette consultation ?</h3>
            <p class="modal-text" id="modalText">Cette action est irrÃ©versible.</p>
            <div class="modal-actions">
                <button class="btn btn-glass modal-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn modal-confirm" id="modalConfirmBtn">Supprimer</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-brand">âœ¦ Aura Intuitive âœ¦</div>
        <p>Â© 2026 Aura Intuitive â€” Panel administrateur</p>
    </footer>

    <script src="script.js"></script>
    <script>
        let consultations = [];
        let currentFilter = 'submitted';
        let previousPendingCount = 0;
        let autoRefreshTimer = null;

        /* â”€â”€ Notification sound â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function playNotifSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.setValueAtTime(1100, ctx.currentTime + 0.1);
                osc.frequency.setValueAtTime(880, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } catch {}
        }

        /* â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        document.getElementById('loginPassword').addEventListener('keydown', e => {
            if (e.key === 'Enter') login();
        });

        async function login() {
            const pw = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            errEl.style.display = 'none';

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pw })
                });

                if (res.ok) {
                    showDashboard();
                } else {
                    errEl.textContent = 'Mot de passe incorrect.';
                    errEl.style.display = 'block';
                }
            } catch {
                errEl.textContent = 'Erreur de connexion.';
                errEl.style.display = 'block';
            }
        }

        async function logout() {
            clearInterval(autoRefreshTimer);
            await fetch('/api/admin/logout', { method: 'POST' });
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            loadAll();
            // Auto-refresh every 30 seconds
            autoRefreshTimer = setInterval(loadAll, 30000);
        }

        /* â”€â”€ Load all data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function loadAll() {
            await Promise.all([loadConsultations(), loadStats()]);
        }

        /* â”€â”€ Load stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                if (!res.ok) return;
                const stats = await res.json();
                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statPending').textContent = stats.pending;
                document.getElementById('statAnswered').textContent = stats.answered;
                document.getElementById('statRevenue').textContent = stats.revenue + 'â‚¬';
            } catch {}
        }

        /* â”€â”€ Load consultations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function loadConsultations() {
            try {
                const res = await fetch('/api/admin/consultations');
                if (res.status === 401) {
                    clearInterval(autoRefreshTimer);
                    document.getElementById('dashboardSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'none';
                    return;
                }
                consultations = await res.json();

                // Check for new consultations â†’ notification sound
                const newPending = consultations.filter(c => c.status === 'submitted').length;
                if (previousPendingCount > 0 && newPending > previousPendingCount) {
                    playNotifSound();
                    document.title = `(${newPending}) Nouvelle consultation ! â€” Aura Intuitive`;
                    setTimeout(() => { document.title = 'Admin â€” Aura Intuitive'; }, 5000);
                }
                previousPendingCount = newPending;

                renderConsultations();
            } catch {
                document.getElementById('consultList').innerHTML =
                    '<div class="consult-empty">Erreur lors du chargement.</div>';
            }
        }

        /* â”€â”€ Filter tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function filterTab(btn) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderConsultations();
        }

        /* â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function renderConsultations() {
            const list = document.getElementById('consultList');
            const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            let filtered = consultations;

            if (currentFilter !== 'all') {
                filtered = filtered.filter(c => c.status === currentFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(c =>
                    (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                    (c.email && c.email.toLowerCase().includes(searchTerm))
                );
            }

            if (!filtered.length) {
                const msg = searchTerm ? 'Aucun rÃ©sultat pour cette recherche. ğŸ”' : 'Aucune consultation dans cette catÃ©gorie. ğŸŒ™';
                list.innerHTML = `<div class="consult-empty">${msg}</div>`;
                return;
            }

            list.innerHTML = filtered.map(c => {
                const dateStr = c.submitted_at
                    ? new Date(c.submitted_at).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    : 'â€”';

                const badgeClass = c.status === 'answered' ? 'badge-answered' : 'badge-submitted';
                const badgeText = c.status === 'answered' ? 'âœ… RÃ©pondue' : 'âœ¦ En attente';

                // Calculate age from birthdate
                let ageDisplay = '';
                if (c.birthdate) {
                    const birth = new Date(c.birthdate);
                    const today = new Date();
                    let age = today.getFullYear() - birth.getFullYear();
                    const m = today.getMonth() - birth.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
                    ageDisplay = `<span class="consult-age">${age} ans</span>`;
                }

                let responseSection = '';

                if (c.status === 'answered' && c.response) {
                    responseSection = `
                        <div class="consult-response-box">
                            <label>ğŸ“ Votre rÃ©ponse envoyÃ©e :</label>
                            <div class="consult-prev-response">${escapeHtml(c.response)}</div>
                        </div>`;
                } else {
                    responseSection = `
                        <div class="consult-response-box">
                            <label>âœï¸ RÃ©diger votre rÃ©ponse :</label>
                            <textarea id="resp-${c.id}" placeholder="Ã‰crivez votre guidance ici..."></textarea>
                            <div class="consult-actions">
                                <button class="btn btn-gold" onclick="sendResponse('${c.id}', this)">
                                    Envoyer la rÃ©ponse âœ¦
                                </button>
                            </div>
                        </div>`;
                }

                return `
                <div class="consult-card">
                    <div class="consult-top">
                        <span class="consult-service">${escapeHtml(c.service)} â€” ${c.amount}â‚¬</span>
                        <span class="consult-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="consult-meta">
                        <strong>${escapeHtml(c.name || 'â€”')}</strong> ${ageDisplay} Â· ${escapeHtml(c.email || 'â€”')}<br>
                        ${c.birthdate ? '<div class="consult-birthdate-line">ğŸ‚ NÃ©(e) le <strong>' + new Date(c.birthdate).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' }) + '</strong></div>' : ''}
                        ğŸ“… ${dateStr}
                        ${c.person_concerned ? ' Â· ğŸ‘¤ ' + escapeHtml(c.person_concerned) : ''}
                        <div class="consult-meta-actions">
                            ${c.email ? `<button class="btn-tiny" onclick="copyEmail('${escapeHtml(c.email)}', this)" title="Copier l'email">ğŸ“§ Copier email</button>` : ''}
                            <button class="btn-tiny btn-danger" onclick="deleteConsultation('${c.id}', '${escapeHtml(c.name || 'cette consultation')}')" title="Supprimer">ğŸ—‘ï¸ Supprimer</button>
                        </div>
                    </div>
                    <div class="consult-message">${escapeHtml(c.message || 'â€”')}</div>
                    ${responseSection}
                </div>`;
            }).join('');
        }

        /* â”€â”€ Copy email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function copyEmail(email, btn) {
            try {
                await navigator.clipboard.writeText(email);
                const orig = btn.textContent;
                btn.textContent = 'âœ… CopiÃ© !';
                btn.style.color = '#7ddf90';
                setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
            } catch {
                prompt('Copiez l\'email :', email);
            }
        }

        /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function openModal(name) {
            document.getElementById('modalText').textContent =
                `La consultation de ${name} sera dÃ©finitivement supprimÃ©e.`;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('deleteModal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeModal();
        });

        // Close on Escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });

        /* â”€â”€ Delete consultation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function deleteConsultation(id, name) {
            openModal(name);
            const btn = document.getElementById('modalConfirmBtn');
            // Replace onclick to bind current id
            btn.onclick = async () => {
                btn.textContent = 'Suppression...';
                btn.disabled = true;
                try {
                    const res = await fetch(`/api/admin/consultations/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        consultations = consultations.filter(c => c.id !== id);
                        renderConsultations();
                        loadStats();
                    } else {
                        alert('Erreur lors de la suppression.');
                    }
                } catch {
                    alert('Erreur de connexion.');
                }
                btn.textContent = 'Supprimer';
                btn.disabled = false;
                closeModal();
            };
        }

        /* â”€â”€ Send response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        async function sendResponse(id, btn) {
            const textarea = document.getElementById('resp-' + id);
            const response = textarea.value.trim();

            if (!response) {
                alert('Veuillez Ã©crire une rÃ©ponse.');
                return;
            }

            btn.textContent = 'Envoi en cours...';
            btn.disabled = true;
            btn.style.opacity = '0.7';

            try {
                const res = await fetch('/api/admin/respond', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, response })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    if (!data.emailSent) {
                        alert('âœ… RÃ©ponse sauvegardÃ©e !\n\nâš ï¸ L\'email n\'a pas pu Ãªtre envoyÃ©.\nCopiez votre rÃ©ponse et envoyez-la manuellement Ã  l\'adresse email du client.');
                    }
                    const c = consultations.find(x => x.id === id);
                    if (c) {
                        c.status = 'answered';
                        c.response = response;
                        c.answered_at = new Date().toISOString();
                    }
                    renderConsultations();
                    loadStats();
                } else {
                    alert(data.error || 'Erreur lors de l\'envoi.');
                    btn.textContent = 'Envoyer la rÃ©ponse âœ¦';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            } catch {
                alert('Erreur de connexion.');
                btn.textContent = 'Envoyer la rÃ©ponse âœ¦';
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /* â”€â”€ Auto-resize textareas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'TEXTAREA') {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            }
        });

        /* â”€â”€ Auto-check session on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        (async () => {
            try {
                const res = await fetch('/api/admin/consultations');
                if (res.ok) {
                    consultations = await res.json();
                    showDashboard();
                    renderConsultations();
                }
            } catch {}
        })();
    </script>
</body>
</html>
